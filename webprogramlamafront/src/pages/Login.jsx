import React, { useState } from "react";
import { useNavigate } from "react-router-dom";
import { saveToken, saveUser, debugAuth } from "../utils/tokenUtils";

const Login = () => {
  const [isRegister, setIsRegister] = useState(false);
  const [formData, setFormData] = useState({
    username: "",
    email: "",
    password: "",
    confirmPassword: "",
  });
  const [isLoading, setIsLoading] = useState(false);
  const navigate = useNavigate();

  // Backend API URL - D√ºzeltildi (fazla : kaldƒ±rƒ±ldƒ±)
  const API_BASE_URL = "https://localhost:7062/api";

  const handleChange = (e) => {
    setFormData((prev) => ({
      ...prev,
      [e.target.name]: e.target.value,
    }));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setIsLoading(true);

    try {
      if (isRegister) {
        // Kayƒ±t i≈ülemi
        if (formData.password !== formData.confirmPassword) {
          alert("≈ûifreler e≈üle≈ümiyor!");
          setIsLoading(false);
          return;
        }

        const registerData = {
          username: formData.username,
          email: formData.email,
          password: formData.password,
          confirmPassword: formData.confirmPassword,
        };

        console.log(
          "Sending register request to:",
          `${API_BASE_URL}/Auth/Register`
        );
        console.log("Register data:", registerData);

        const res = await fetch(`${API_BASE_URL}/Auth/Register`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Accept: "application/json",
          },
          body: JSON.stringify(registerData),
        });

        console.log("Register response status:", res.status);

        if (!res.ok) {
          const errorText = await res.text();
          console.error("Register error response:", errorText);

          try {
            const errorData = JSON.parse(errorText);
            if (errorData.errors) {
              const errorMessages = Object.values(errorData.errors)
                .flat()
                .join("\n");
              alert(errorMessages);
            } else {
              alert(errorData.message || "Kayƒ±t sƒ±rasƒ±nda bir hata olu≈ütu.");
            }
          } catch (parseError) {
            alert(`Kayƒ±t hatasƒ±: ${res.status} ${res.statusText}`);
          }
          setIsLoading(false);
          return;
        }

        const data = await res.json();
        console.log("Register response data:", data);

        if (data.success && data.token && data.user) {
          // Token ve user'ƒ± g√ºvenli ≈üekilde kaydet
          saveToken(data.token);
          saveUser(data.user);

          console.log("‚úÖ Kayƒ±t ba≈üarƒ±lƒ±, authentication verileri kaydedildi");
          debugAuth();

          alert("Kayƒ±t ba≈üarƒ±lƒ±! Ho≈ü geldiniz!");
          navigate("/");
        } else {
          throw new Error("Kayƒ±t yanƒ±tƒ±nda token veya user bilgisi eksik");
        }
      } else {
        // Giri≈ü i≈ülemi
        const loginData = {
          email: formData.email,
          password: formData.password,
        };

        console.log("Sending login request to:", `${API_BASE_URL}/Auth/Login`);
        console.log("Login data:", { email: loginData.email, password: "***" });

        const res = await fetch(`${API_BASE_URL}/Auth/Login`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Accept: "application/json",
          },
          body: JSON.stringify(loginData),
        });

        console.log("Login response status:", res.status);

        if (!res.ok) {
          const errorText = await res.text();
          console.error("Login error response:", errorText);

          try {
            const errorData = JSON.parse(errorText);
            alert(errorData.message || "Giri≈ü ba≈üarƒ±sƒ±z.");
          } catch (parseError) {
            alert(`Giri≈ü hatasƒ±: ${res.status} ${res.statusText}`);
          }
          setIsLoading(false);
          return;
        }

        const data = await res.json();
        console.log("Login response data:", data);

        if (data.success && data.token && data.user) {
          // Token ve user'ƒ± g√ºvenli ≈üekilde kaydet
          saveToken(data.token);
          saveUser(data.user);

          console.log("‚úÖ Giri≈ü ba≈üarƒ±lƒ±, authentication verileri kaydedildi");
          console.log("üîê Kaydedilen user:", data.user);
          console.log("üé´ Kaydedilen token uzunluƒüu:", data.token.length);

          // Debug authentication durumu
          debugAuth();

          alert(`Ho≈ü geldiniz, ${data.user.username}!`);
          navigate("/");
        } else {
          throw new Error("Giri≈ü yanƒ±tƒ±nda token veya user bilgisi eksik");
        }
      }
    } catch (error) {
      console.error("API Error:", error);
      console.error("Error details:", {
        name: error.name,
        message: error.message,
        stack: error.stack,
      });

      // Hata t√ºr√ºne g√∂re √∂zel mesajlar
      if (
        error.name === "TypeError" &&
        error.message.includes("Failed to fetch")
      ) {
        alert(
          "Sunucuya baƒülanƒ±lamƒ±yor. Backend sunucusunun √ßalƒ±≈ütƒ±ƒüƒ±ndan emin olun.\n\nKontrol edilecekler:\n1. Backend projesinin √ßalƒ±≈üƒ±yor olmasƒ±\n2. URL'nin doƒüru olmasƒ± (https://localhost:7062)\n3. CORS ayarlarƒ±nƒ±n yapƒ±lmƒ±≈ü olmasƒ±"
        );
      } else if (
        error.name === "TypeError" &&
        error.message.includes("NetworkError")
      ) {
        alert("Aƒü baƒülantƒ± hatasƒ±. ƒ∞nternet baƒülantƒ±nƒ±zƒ± kontrol edin.");
      } else {
        alert(
          "Beklenmeyen bir hata olu≈ütu. L√ºtfen tekrar deneyin.\n\nHata: " +
            error.message
        );
      }
    } finally {
      setIsLoading(false);
    }
  };

  // Test hesaplarƒ± ile hƒ±zlƒ± giri≈ü
  const quickLogin = async (email, password) => {
    setIsLoading(true);
    setFormData({ ...formData, email, password });

    try {
      console.log("Quick login attempt:", email);

      const res = await fetch(`${API_BASE_URL}/Auth/Login`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Accept: "application/json",
        },
        body: JSON.stringify({ email, password }),
      });

      console.log("Quick login response status:", res.status);

      if (!res.ok) {
        const errorText = await res.text();
        console.error("Quick login error:", errorText);
        alert("Hƒ±zlƒ± giri≈ü ba≈üarƒ±sƒ±z. Test hesabƒ± mevcut olmayabilir.");
        setIsLoading(false);
        return;
      }

      const data = await res.json();
      console.log("Quick login response:", data);

      if (data.success && data.token && data.user) {
        // Token ve user'ƒ± g√ºvenli ≈üekilde kaydet
        saveToken(data.token);
        saveUser(data.user);

        console.log("‚úÖ Hƒ±zlƒ± giri≈ü ba≈üarƒ±lƒ±");
        debugAuth();

        alert(`Ho≈ü geldiniz, ${data.user.username}!`);
        navigate("/");
      } else {
        throw new Error("Hƒ±zlƒ± giri≈ü yanƒ±tƒ±nda token veya user bilgisi eksik");
      }
    } catch (error) {
      console.error("Quick Login Error:", error);
      alert("Hƒ±zlƒ± giri≈ü sƒ±rasƒ±nda baƒülantƒ± hatasƒ± olu≈ütu.");
    } finally {
      setIsLoading(false);
    }
  };

  // Test baƒülantƒ±sƒ± i√ßin debug fonksiyonu
  const testConnection = async () => {
    try {
      console.log("Testing connection to:", API_BASE_URL);
      const res = await fetch(`${API_BASE_URL}/Auth/Me`, {
        method: "GET",
        headers: {
          Accept: "application/json",
        },
      });

      console.log("Test connection response:", res.status, res.statusText);

      if (res.status === 401) {
        alert(
          "‚úÖ Backend baƒülantƒ±sƒ± ba≈üarƒ±lƒ±! (401 - Unauthorized beklenen durum)"
        );
      } else {
        alert(`Backend yanƒ±t verdi: ${res.status} ${res.statusText}`);
      }
    } catch (error) {
      console.error("Connection test failed:", error);
      alert(
        "‚ùå Backend baƒülantƒ±sƒ± ba≈üarƒ±sƒ±z!\n\nKontrol edin:\n1. Backend projesi √ßalƒ±≈üƒ±yor mu?\n2. Port numarasƒ± doƒüru mu? (7062)\n3. HTTPS sertifika sorunu var mƒ±?"
      );
    }
  };

  const containerStyle = {
    maxWidth: "400px",
    margin: "50px auto",
    padding: "20px",
    border: "1px solid #ccc",
    borderRadius: "8px",
    fontFamily: "Arial, sans-serif",
    backgroundColor: "#f9f9f9",
    boxShadow: "0 2px 10px rgba(0,0,0,0.1)",
  };

  const inputStyle = {
    width: "100%",
    padding: "10px",
    marginBottom: "10px",
    borderRadius: "4px",
    border: "1px solid #aaa",
    boxSizing: "border-box",
    fontSize: "14px",
  };

  const buttonStyle = {
    width: "100%",
    padding: "10px",
    backgroundColor: isLoading ? "#ccc" : "#007BFF",
    color: "white",
    border: "none",
    borderRadius: "4px",
    cursor: isLoading ? "not-allowed" : "pointer",
    marginBottom: "10px",
    fontSize: "16px",
    fontWeight: "500",
  };

  const toggleStyle = {
    marginTop: "10px",
    textAlign: "center",
    cursor: "pointer",
    color: "#007BFF",
    textDecoration: "underline",
    fontSize: "14px",
  };

  const testAccountsStyle = {
    marginTop: "20px",
    padding: "15px",
    backgroundColor: "#e3f2fd",
    borderRadius: "4px",
    fontSize: "12px",
    border: "1px solid #bbdefb",
  };

  const quickLoginButtonStyle = {
    padding: "8px 12px",
    margin: "5px",
    backgroundColor: "#28a745",
    color: "white",
    border: "none",
    borderRadius: "4px",
    cursor: "pointer",
    fontSize: "12px",
    fontWeight: "500",
    transition: "background-color 0.2s",
  };

  const debugButtonStyle = {
    padding: "5px 10px",
    backgroundColor: "#17a2b8",
    color: "white",
    border: "none",
    borderRadius: "3px",
    cursor: "pointer",
    fontSize: "11px",
    marginTop: "10px",
    width: "100%",
  };

  return (
    <div style={containerStyle}>
      <h2 style={{ textAlign: "center", marginBottom: "20px", color: "#333" }}>
        {isRegister ? "Kayƒ±t Ol" : "Giri≈ü Yap"}
      </h2>

      <form onSubmit={handleSubmit}>
        {isRegister && (
          <input
            style={inputStyle}
            type="text"
            name="username"
            placeholder="Kullanƒ±cƒ± Adƒ±"
            value={formData.username}
            onChange={handleChange}
            required
            minLength="3"
          />
        )}

        <input
          style={inputStyle}
          type="email"
          name="email"
          placeholder="Email"
          value={formData.email}
          onChange={handleChange}
          required
        />

        <input
          style={inputStyle}
          type="password"
          name="password"
          placeholder="≈ûifre"
          value={formData.password}
          onChange={handleChange}
          required
          minLength="6"
        />

        {isRegister && (
          <input
            style={inputStyle}
            type="password"
            name="confirmPassword"
            placeholder="≈ûifre Tekrar"
            value={formData.confirmPassword}
            onChange={handleChange}
            required
            minLength="6"
          />
        )}

        <button style={buttonStyle} type="submit" disabled={isLoading}>
          {isLoading
            ? isRegister
              ? "Kayƒ±t Olunuyor..."
              : "Giri≈ü Yapƒ±lƒ±yor..."
            : isRegister
            ? "Kayƒ±t Ol"
            : "Giri≈ü Yap"}
        </button>
      </form>

      {/* Debug butonu */}
      <button style={debugButtonStyle} onClick={testConnection} type="button">
        üîß Backend Baƒülantƒ±sƒ±nƒ± Test Et
      </button>

      <div
        style={toggleStyle}
        onClick={() => {
          setIsRegister(!isRegister);
          setFormData({
            username: "",
            email: "",
            password: "",
            confirmPassword: "",
          });
        }}
      >
        {isRegister
          ? "Zaten hesabƒ±nƒ±z var mƒ±? Giri≈ü Yap"
          : "Hesabƒ±nƒ±z yok mu? Kayƒ±t Ol"}
      </div>

      {/* Test Hesaplarƒ± - Sadece giri≈ü sayfasƒ±nda g√∂ster */}
      {!isRegister && (
        <div style={testAccountsStyle}>
          <h4
            style={{ margin: "0 0 15px 0", color: "#1976d2", fontSize: "14px" }}
          >
            üß™ Test Hesaplarƒ±:
          </h4>

          <div style={{ marginBottom: "10px" }}>
            <div
              style={{
                marginBottom: "5px",
                fontSize: "13px",
                fontWeight: "bold",
              }}
            >
              üë®‚Äçüíº Admin Hesabƒ±:
            </div>
            <div
              style={{ fontSize: "11px", color: "#666", marginBottom: "5px" }}
            >
              Email: admin@example.com | ≈ûifre: Admin123!
            </div>
            <button
              type="button"
              style={quickLoginButtonStyle}
              onClick={() => quickLogin("admin@example.com", "Admin123!")}
              disabled={isLoading}
              onMouseOver={(e) => (e.target.style.backgroundColor = "#218838")}
              onMouseOut={(e) => (e.target.style.backgroundColor = "#28a745")}
            >
              üë®‚Äçüíº Admin Giri≈üi
            </button>
          </div>

          <div>
            <div
              style={{
                marginBottom: "5px",
                fontSize: "13px",
                fontWeight: "bold",
              }}
            >
              üë§ Kullanƒ±cƒ± Hesabƒ±:
            </div>
            <div
              style={{ fontSize: "11px", color: "#666", marginBottom: "5px" }}
            >
              Email: user@test.com | ≈ûifre: Test123!
            </div>
            <button
              type="button"
              style={quickLoginButtonStyle}
              onClick={() => quickLogin("user@test.com", "Test123!")}
              disabled={isLoading}
              onMouseOver={(e) => (e.target.style.backgroundColor = "#218838")}
              onMouseOut={(e) => (e.target.style.backgroundColor = "#28a745")}
            >
              üë§ User Giri≈üi
            </button>
          </div>

          <div
            style={{
              marginTop: "10px",
              fontSize: "10px",
              color: "#666",
              fontStyle: "italic",
              textAlign: "center",
            }}
          >
            ‚ÑπÔ∏è Bu hesaplar test ama√ßlƒ±dƒ±r. Ger√ßek projede kaldƒ±rƒ±lmalƒ±dƒ±r.
          </div>
        </div>
      )}

      {/* Authentication Debug Butonu */}
      <button
        style={{
          ...debugButtonStyle,
          backgroundColor: "#6f42c1",
          marginTop: "5px",
        }}
        onClick={() => {
          debugAuth();
          alert("Authentication durumu console'da g√∂r√ºnt√ºlendi");
        }}
        type="button"
      >
        üîç Authentication Durumunu Kontrol Et
      </button>
    </div>
  );
};

export default Login;
